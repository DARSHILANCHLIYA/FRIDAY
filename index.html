<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Chat Pro - Real Time</title>
<script src="https://cdn.tailwindcss.com  "></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css  ">
<style>
/* Custom Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #1e1e1e; }
::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }

#sidebar { transition: margin-left 0.3s ease-in-out; }
.sidebar-closed { margin-left: -18rem; }

.model-slider { position: relative; display: flex; background: #2f2f2f; padding: 4px; border-radius: 12px; }
.model-option { position: relative; padding: 6px 16px; cursor: pointer; font-size: 13px; z-index: 10; transition: color 0.3s; font-weight: 500; }
.slider-bg { position: absolute; height: calc(100% - 8px); background: #3b82f6; border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1; }

body.assistant-mode .slider-bg { background: #9333ea; }
body.assistant-mode .user-bubble { background: #9333ea; }
body.assistant-mode .ai-avatar { background: #9333ea; }
body.assistant-mode .active-chat { border-l-color: #9333ea !important; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
.animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

/* Loading Dots Animation */
.typing-dot { width: 4px; height: 4px; background: #9ca3af; border-radius: 50%; animation: typing 1.4s infinite; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

/* Mic Recording Animation */
@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
.mic-recording { animation: pulse 1s infinite; background: #ef4444 !important; }

/* File Preview */
.file-preview { display: inline-flex; align-items: center; gap: 6px; background: #374151; padding: 6px 12px; border-radius: 8px; font-size: 12px; margin: 4px; }

/* Desktop App Modal */
#desktopModal { z-index: 200; }
.desktop-modal-content { background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); }

/* Message Actions */
.message-actions {
    position: absolute;
    top: -10px;
    right: 10px;
    display: none;
    gap: 4px;
    background: #2d2d2d;
    padding: 4px;
    border-radius: 8px;
    border: 1px solid #4b5563;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10;
}

.message-container:hover .message-actions {
    display: flex;
}

.message-action-btn {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    background: #374151;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
}

.message-action-btn:hover {
    background: #4b5563;
    color: white;
}

.message-action-btn.edit:hover { background: #3b82f6; color: white; }
.message-action-btn.delete:hover { background: #ef4444; color: white; }

/* Chat Actions */
.chat-actions {
    opacity: 0;
    transition: opacity 0.2s;
}

.chat-item:hover .chat-actions {
    opacity: 1;
}

/* Notification */
.notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease-out;
    max-width: 300px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
</style>
</head>
<body class="bg-[#1e1e1e] text-gray-200 flex h-screen overflow-hidden font-sans selection:bg-blue-500/30">

<!-- Desktop App Download Modal -->
<div id="desktopModal" class="fixed inset-0 bg-black/95 z-[200] flex items-center justify-center hidden backdrop-blur-xl">
<div class="desktop-modal-content p-8 rounded-2xl border border-gray-700 w-96 shadow-2xl text-center">
<div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
<i class="fa-solid fa-rocket text-3xl text-white"></i>
</div>
<h3 class="text-2xl font-bold mb-3 text-white">ðŸš€ Enhanced Experience</h3>
<p class="text-sm text-gray-300 mb-6 leading-relaxed" id="desktopModalText">
Get <strong class="text-blue-300">5x faster</strong> web search, <strong class="text-purple-300">unlimited</strong> file processing, and <strong class="text-green-300">offline capabilities</strong> with our desktop app!
</p>
<div class="space-y-3">
<button onclick="downloadDesktopApp()" class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl hover:opacity-90 font-bold text-white transition flex items-center justify-center gap-3 shadow-lg">
<i class="fa-solid fa-download"></i>
DOWNLOAD DESKTOP APP
</button>
<button onclick="closeDesktopModal()" class="w-full py-3 bg-gray-800 rounded-xl text-gray-300 hover:text-white transition font-medium">
Continue in Browser
</button>
</div>
</div>
</div>

<div id="apiKeyModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center hidden backdrop-blur-md">
<div class="bg-[#2d2d2d] p-8 rounded-2xl border border-gray-700 w-96 shadow-2xl text-center">
<h3 class="text-xl font-bold mb-2 text-white">Groq Activation</h3>
<p class="text-sm text-gray-400 mb-6">Enter your API key to connect to the models.</p>
<input type="password" id="apiKeyInput" class="w-full bg-[#1e1e1e] border border-gray-600 rounded-lg p-3 text-sm outline-none focus:border-blue-500 mb-4 text-white placeholder-gray-700" placeholder="GROQ API KEY" autocomplete="off">
<button onclick="saveApiKey()" class="w-full py-3 bg-blue-600 rounded-lg hover:bg-blue-500 font-bold text-white transition mb-3 shadow-lg">Save & Initialize</button>
<a href="https://console.groq.com/keys  " target="_blank" class="block w-full py-3 bg-gray-800 rounded-lg text-gray-300 hover:text-white transition text-sm font-medium">
<i class="fa-solid fa-arrow-up-right-from-square mr-2"></i> GET API KEY
</a>
</div>
</div>

<div id="nameModal" class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center hidden backdrop-blur-sm">
<div class="bg-[#2d2d2d] p-6 rounded-xl border border-gray-700 w-80 shadow-2xl">
<h3 class="text-lg font-bold mb-1 text-white">New Chat</h3>
<input type="text" id="chatNameInput" class="w-full bg-[#1e1e1e] border border-gray-600 rounded-lg p-3 text-sm outline-none focus:border-blue-500 mb-4 text-white" placeholder="Chat topic..." autocomplete="off">
<div class="flex justify-end gap-2">
<button onclick="closeModal()" class="px-4 py-2 text-sm text-gray-400 hover:text-white transition">Cancel</button>
<button onclick="confirmNewChat()" class="px-4 py-2 text-sm bg-blue-600 rounded-lg hover:bg-blue-500 font-semibold text-white transition">Create</button>
</div>
</div>
</div>

<aside id="sidebar" class="w-72 bg-[#171717] flex flex-col border-r border-gray-800 relative z-50 shrink-0">
<button onclick="toggleSidebar()" class="absolute -right-8 top-6 bg-[#171717] p-2 w-8 h-10 border-y border-r border-gray-800 rounded-r-lg hover:text-blue-400 transition flex items-center justify-center text-gray-400 z-50 shadow-md">
<i id="toggleIcon" class="fa-solid fa-chevron-left text-xs"></i>
</button>

<div class="p-4 flex flex-col h-full">
<button onclick="openNameModal()" class="flex items-center gap-3 border border-gray-700 bg-[#1e1e1e] hover:bg-[#2a2a2a] rounded-xl p-3 transition-all mb-6 group shadow-sm">
<div class="bg-blue-600/20 p-1.5 rounded-lg group-hover:bg-blue-600 transition">
<i class="fa-solid fa-plus text-blue-400 text-xs group-hover:text-white"></i>
</div>
<span class="text-sm font-medium text-gray-300 group-hover:text-white">New Conversation</span>
</button>

<div class="flex-1 overflow-y-auto pr-2 -mr-2">
<p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-3 pl-1">Recent Chats</p>
<div id="history-list" class="space-y-1"></div>
</div>

<div class="mt-auto pt-4 border-t border-gray-800 space-y-3">
<div class="flex items-center justify-between p-3 bg-blue-500/5 rounded-xl border border-blue-500/20">
<div class="flex items-center gap-2">
<i class="fa-solid fa-globe text-blue-400 text-xs"></i>
<span class="text-xs font-medium text-blue-200">Web Search</span>
</div>
<label class="relative inline-flex items-center cursor-pointer">
<input type="checkbox" id="webSearchToggle" class="sr-only peer">
<div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4"></div>
</label>
</div>
<div class="flex items-center justify-between p-3 bg-purple-500/5 rounded-xl border border-purple-500/20">
<div class="flex items-center gap-2">
<i class="fa-solid fa-wand-magic-sparkles text-purple-400 text-xs"></i>
<span class="text-xs font-medium text-purple-200">Assistant Mode</span>
</div>
<label class="relative inline-flex items-center cursor-pointer">
<input type="checkbox" id="assistantToggle" class="sr-only peer">
<div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:bg-purple-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4"></div>
</label>
</div>
<button onclick="showDesktopPrompt('full')" class="w-full py-2.5 mt-2 bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-xl text-xs font-medium text-blue-300 hover:text-white hover:from-blue-600/30 hover:to-purple-600/30 transition flex items-center justify-center gap-2">
<i class="fa-solid fa-rocket"></i>
Upgrade to Desktop App
</button>
<button onclick="resetKey()" class="text-[10px] text-gray-600 hover:text-red-400 w-full text-center pb-2">Logout / Clear API Key</button>
</div>
</div>
</aside>

<main class="flex-1 flex flex-col relative min-w-0 bg-[#1e1e1e]">
<header class="h-16 border-b border-gray-800 flex items-center justify-center sticky top-0 bg-[#1e1e1e]/90 backdrop-blur z-40">
<div class="model-slider shadow-lg">
<div class="slider-bg" id="sliderBg"></div>
<div class="model-option text-white" onclick="selectModel(0)">Llama </div>
<div class="model-option text-gray-400" onclick="selectModel(1)">Qwen</div>
<div class="model-option text-gray-400" onclick="selectModel(2)">Chatgpt</div>
</div>
</header>

<div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth"></div>

<div class="p-4 pb-6">
<div class="max-w-3xl mx-auto relative">
<div id="filePreviewContainer" class="mb-2 flex flex-wrap hidden"></div>
<div class="bg-[#2f2f2f] rounded-2xl border border-gray-700 flex items-end p-2 shadow-2xl focus-within:border-gray-500 transition-all">
<input type="file" id="fileInput" multiple class="hidden" accept="image/*,.pdf,.txt,.doc,.docx">
<button onclick="document.getElementById('fileInput').click()" class="p-3 text-gray-400 hover:text-white hover:bg-gray-700 rounded-xl transition">
<i class="fa-solid fa-paperclip text-lg"></i>
</button>
<textarea id="user-input" rows="1" class="flex-1 bg-transparent border-none outline-none text-gray-200 placeholder-gray-500 p-3 max-h-32 resize-none" placeholder="Message AI..." onkeydown="handleKeyPress(event)"></textarea>
<button id="mic-btn" onclick="toggleVoiceInput()" class="p-3 text-gray-400 hover:text-white hover:bg-gray-700 rounded-xl transition">
<i class="fa-solid fa-microphone text-lg"></i>
</button>
<button onclick="sendMessage()" id="send-btn" class="p-3 bg-white text-black rounded-xl hover:bg-gray-200 transition ml-1">
<i class="fa-solid fa-arrow-up"></i>
</button>
</div>
<button onclick="showDesktopPrompt('full')" class="mt-3 text-xs text-blue-400 hover:text-blue-300 transition flex items-center gap-1 mx-auto">
<i class="fa-solid fa-bolt"></i>
Desktop app: 5x faster web search & unlimited files
</button>
</div>
</div>
</main>

<script>
const modelConfig = [
{ short: "Llama", full: "llama-3.3-70b-versatile" },
{ short: "Qwen", full: "qwen/qwen3-32b" },
{ short: "Chatgpt", full: "openai/gpt-oss-120b" }
];

let activeModel = modelConfig[0];
let chats = JSON.parse(localStorage.getItem('chats')) || [{ id: Date.now(), title: "Initial Conversation", messages: [] }];
let activeId = chats[0].id;
let isProcessing = false;
let uploadedFiles = [];
let recognition = null;
let isRecording = false;
let silenceTimer = null;
let finalTranscript = '';
let editingMessageId = null;
let desktopPromptShown = false;

// --- DESKTOP APP FUNCTIONS ---
function showDesktopPrompt(feature) {
const modal = document.getElementById('desktopModal');
modal.classList.remove('hidden');
desktopPromptShown = true;
}

function closeDesktopModal() {
document.getElementById('desktopModal').classList.add('hidden');
}

function downloadDesktopApp() {
// Open download page
window.open('https://github.com/your-repo/ai-chat-pro/releases  ', '_blank');
showNotification('Download started! Check your downloads folder.');
closeDesktopModal();
}

function showNotification(message) {
const notification = document.createElement('div');
notification.className = 'notification';
notification.innerHTML = `
<i class="fa-solid fa-check-circle"></i>
<span>${message}</span>
`;
document.body.appendChild(notification);
setTimeout(() => notification.remove(), 3000);
}

// --- AUTH ---
function saveApiKey() {
const key = document.getElementById('apiKeyInput').value.trim();
if (key) { 
localStorage.setItem('groq_key', key); 
document.getElementById('apiKeyModal').classList.add('hidden');
showNotification('API key saved successfully!');
}
}

function checkKey() { 
if (!localStorage.getItem('groq_key')) {
document.getElementById('apiKeyModal').classList.remove('hidden');
}
}

function resetKey() { 
localStorage.removeItem('groq_key'); 
localStorage.removeItem('chats');
location.reload(); 
}

// --- MODEL SELECT ---
function selectModel(index) {
activeModel = modelConfig[index];
const bg = document.getElementById('sliderBg');
const options = document.querySelectorAll('.model-option');
bg.style.width = options[index].offsetWidth + 'px';
bg.style.left = options[index].offsetLeft + 'px';
options.forEach((opt, i) => {
opt.classList.toggle('text-white', i === index);
opt.classList.toggle('text-gray-400', i !== index);
});
}

// --- UI ACTIONS ---
function toggleSidebar() {
const sidebar = document.getElementById('sidebar');
sidebar.classList.toggle('sidebar-closed');
document.getElementById('toggleIcon').className = sidebar.classList.contains('sidebar-closed') ? 'fa-solid fa-chevron-right text-xs' : 'fa-solid fa-chevron-left text-xs';
}

function openNameModal() { document.getElementById('nameModal').classList.remove('hidden'); }
function closeModal() { document.getElementById('nameModal').classList.add('hidden'); }

function confirmNewChat() {
const name = document.getElementById('chatNameInput').value || "New Chat";
const newId = Date.now();
chats.unshift({ id: newId, title: name, messages: [] });
saveChats();
closeModal();
selectChat(newId);
}

function saveChats() {
localStorage.setItem('chats', JSON.stringify(chats));
}

function renderHistory() {
const isAssistant = document.body.classList.contains('assistant-mode');
document.getElementById('history-list').innerHTML = chats.map(chat => `
<div onclick="selectChat(${chat.id})" class="chat-item active-chat group flex items-center justify-between p-3 rounded-lg cursor-pointer text-sm transition ${chat.id === activeId ? (isAssistant ? 'bg-[#2f2f2f] text-white border-l-4 border-purple-500' : 'bg-[#2f2f2f] text-white border-l-4 border-blue-500') : 'text-gray-400 hover:bg-[#252525]'}">
<span class="truncate w-32">${chat.title}</span>
<div class="chat-actions flex gap-1">
<button onclick="event.stopPropagation(); renameChat(${chat.id})" class="p-1.5 hover:bg-gray-700 rounded text-gray-500 hover:text-gray-300 transition">
<i class="fa-solid fa-pencil text-xs"></i>
</button>
<button onclick="event.stopPropagation(); deleteChat(${chat.id})" class="p-1.5 hover:bg-red-900/30 rounded text-gray-500 hover:text-red-400 transition">
<i class="fa-solid fa-trash text-xs"></i>
</button>
</div>
</div>`).join('');
}

function deleteChat(chatId) {
if (confirm('Delete this conversation?')) {
chats = chats.filter(c => c.id !== chatId);
saveChats();
if (activeId === chatId && chats.length > 0) {
selectChat(chats[0].id);
} else if (chats.length === 0) {
// Create new chat if all are deleted
const newId = Date.now();
chats = [{ id: newId, title: "New Conversation", messages: [] }];
saveChats();
selectChat(newId);
}
renderHistory();
}
}

function renameChat(chatId) {
const chat = chats.find(c => c.id === chatId);
const newName = prompt('Rename conversation:', chat.title);
if (newName && newName.trim()) {
chat.title = newName.trim();
saveChats();
renderHistory();
}
}

function selectChat(id) {
activeId = id;
const chat = chats.find(c => c.id === id);
document.getElementById('chat-window').innerHTML = '';
chat.messages.forEach((m, index) => appendUI(m.content, m.role === 'user', false, index));
renderHistory();
uploadedFiles = [];
updateFilePreview();
}

function appendUI(text, isUser, isLoading = false, messageIndex = null) {
const window = document.getElementById('chat-window');
const color = document.body.classList.contains('assistant-mode') ? 'bg-purple-600' : 'bg-blue-600';
const id = isLoading ? 'id="loading-bubble"' : '';
const messageId = messageIndex !== null ? `data-index="${messageIndex}"` : `data-index="${Date.now()}"`;

const content = isLoading ?
`<div class="flex gap-1 py-2"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>` :
text.replace(/\n/g, '<br>');

const html = `
<div ${id} ${messageId} class="message-container flex ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in relative">
${isUser ? `<div class="message-actions">
<button class="message-action-btn edit" onclick="editMessage(this)" title="Edit">
<i class="fa-solid fa-pencil"></i>
</button>
<button class="message-action-btn delete" onclick="deleteMessage(this)" title="Delete">
<i class="fa-solid fa-trash"></i>
</button>
</div>` : ''}
<div class="max-w-[85%] flex ${isUser ? 'flex-row-reverse' : 'flex-row'} gap-3">
<div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-[10px] font-bold ${isUser ? 'bg-gray-600' : 'ai-avatar ' + color} text-white">${isUser ? 'YOU' : 'AI'}</div>
<div class="p-3.5 rounded-2xl text-[15px] shadow-md ${isUser ? 'user-bubble ' + color + ' text-white rounded-tr-none' : 'bg-[#2f2f2f] text-gray-200 rounded-tl-none'}">
${content}
</div>
</div>
</div>`;
window.insertAdjacentHTML('beforeend', html);
window.scrollTo(0, window.scrollHeight);
}

// --- ENHANCED MESSAGE ACTIONS ---
function editMessage(btn) {
  const messageContainer = btn.closest('.message-container');
  const messageIndex = parseInt(messageContainer.getAttribute('data-index'));
  const chat = chats.find(c => c.id === activeId);
  
  if (!chat || messageIndex < 0) return;

  const message = chat.messages[messageIndex];
  if (message && message.role === 'user') {
    // Keep only messages up to (but not including) the one being edited
    chat.messages = chat.messages.slice(0, messageIndex);
    
    saveChats();
    selectChat(activeId);

    // Load original message into input for editing
    document.getElementById('user-input').value = message.content;
    document.getElementById('user-input').focus();
    editingMessageId = null; // Not needed anymore â€” weâ€™ve truncated the chat
  }
}

function deleteMessage(btn) {
  const messageContainer = btn.closest('.message-container');
  const messageIndex = parseInt(messageContainer.getAttribute('data-index'));
  const chat = chats.find(c => c.id === activeId);
  
  if (!chat || messageIndex < 0) return;

  if (confirm('Delete this message and all replies after it?')) {
    // Keep only messages BEFORE the selected one
    chat.messages = chat.messages.slice(0, messageIndex);
    
    saveChats();
    selectChat(activeId);
  }
}

// --- FILE UPLOAD ---
document.getElementById('fileInput').onchange = (e) => {
const files = Array.from(e.target.files);
files.forEach(file => {
if (file.size > 10 * 1024 * 1024) {
alert(`File ${file.name} is too large. Max 10MB.`);
return;
}
uploadedFiles.push(file);
});
updateFilePreview();
e.target.value = '';
};

function updateFilePreview() {
const container = document.getElementById('filePreviewContainer');
if (uploadedFiles.length === 0) {
container.classList.add('hidden');
return;
}
container.classList.remove('hidden');
container.innerHTML = uploadedFiles.map((file, idx) => `
<div class="file-preview">
<i class="fa-solid fa-file text-blue-400"></i>
<span class="text-gray-300">${file.name}</span>
<button onclick="removeFile(${idx})" class="text-red-400 hover:text-red-300 ml-2">
<i class="fa-solid fa-times"></i>
</button>
</div>
`).join('');
}

function removeFile(idx) {
uploadedFiles.splice(idx, 1);
updateFilePreview();
}

async function processFiles() {
if (uploadedFiles.length === 0) return '';

let fileContext = '\n\n[ATTACHED FILES]\n';
for (const file of uploadedFiles) {
if (file.type.startsWith('image/')) {
fileContext += `- Image: ${file.name} (${(file.size / 1024).toFixed(1)}KB)\n`;
} else if (file.type === 'application/pdf') {
fileContext += `- PDF Document: ${file.name} (${(file.size / 1024).toFixed(1)}KB)\n`;
} else {
try {
const text = await file.text();
fileContext += `- ${file.name}:\n${text.substring(0, 1000)}${text.length > 1000 ? '...' : ''}\n`;
} catch (e) {
fileContext += `- ${file.name}: Could not read file content\n`;
}
}
}
return fileContext;
}

// --- VOICE INPUT ---
function initVoiceRecognition() {
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
recognition = new SpeechRecognition();
recognition.continuous = true;
recognition.interimResults = true;
recognition.lang = 'en-US';

recognition.onresult = (e) => {
let interimTranscript = '';

for (let i = e.resultIndex; i < e.results.length; i++) {
const transcript = e.results[i][0].transcript;
if (e.results[i].isFinal) {
finalTranscript += transcript + ' ';
} else {
interimTranscript += transcript;
}
}

document.getElementById('user-input').value = finalTranscript + interimTranscript;

clearTimeout(silenceTimer);

silenceTimer = setTimeout(() => {
if (isRecording && finalTranscript.trim()) {
stopRecording();
sendMessage();
}
}, 2000);
};

recognition.onerror = (e) => {
console.error('Speech recognition error:', e.error);
stopRecording();
};

recognition.onend = () => {
if (isRecording) {
recognition.start();
}
};
}
}

function toggleVoiceInput() {
if (!recognition) {
alert('Voice input is not supported in your browser.');
return;
}

if (isRecording) {
stopRecording();
} else {
startRecording();
}
}

function startRecording() {
finalTranscript = '';
document.getElementById('user-input').value = '';
isRecording = true;
recognition.start();
const micBtn = document.getElementById('mic-btn');
micBtn.classList.add('mic-recording');
micBtn.innerHTML = '<i class="fa-solid fa-circle text-lg"></i>';
}

function stopRecording() {
isRecording = false;
clearTimeout(silenceTimer);
if (recognition) recognition.stop();
const micBtn = document.getElementById('mic-btn');
micBtn.classList.remove('mic-recording');
micBtn.innerHTML = '<i class="fa-solid fa-microphone text-lg"></i>';
finalTranscript = '';
}

// --- ENHANCED WEB SEARCH (No API Key Needed) ---
async function performWebSearch(query) {
  try {
    if (!desktopPromptShown) {
      setTimeout(() => showDesktopPrompt('web'), 1500);
    }

    const encodedQuery = encodeURIComponent(query.trim());
    let combinedResults = `ðŸ” **Search Results for: "${query}"**\n\n`;

    // 1. Wikipedia (direct CORS-supported REST API)
    try {
      const wikiRes = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodedQuery}`);
      if (wikiRes.ok) {
        const wiki = await wikiRes.json();
        if (wiki.title && wiki.extract) {
          combinedResults += `**ðŸ“š Wikipedia:**\nâ€¢ **${wiki.title}**\n${wiki.extract}\n\n`;
        }
      }
    } catch (e) {
      console.warn("Wikipedia fetch failed");
    }

    // 2. General Web Search via search.dog (no key, CORS enabled)
    try {
      const searchRes = await fetch(`https://search.dog/api/search?q=${encodedQuery}`);
      if (searchRes.ok) {
        const data = await searchRes.json();
        const results = data.results || [];
        if (results.length > 0) {
          combinedResults += `**ðŸŒ Web Results:**\n`;
          results.slice(0, 4).forEach((res, i) => {
            const desc = (res.snippet || '').replace(/\s+/g, ' ').trim();
            combinedResults += `${i + 1}. **${res.title}**\n${desc.substring(0, 150)}...\n\n`;
          });
        }
      }
    } catch (e) {
      console.warn("search.dog failed", e);
    }

    // Fallback
    if (combinedResults === `ðŸ” **Search Results for: "${query}"**\n\n`) {
      combinedResults = `ðŸŒ **Search completed for: "${query}"**\n\nâš ï¸ Public search is limited in browser.\n\nðŸ’¡ **Pro Tip:** Download the **desktop app** for:\nâ€¢ Full Google/Bing results\nâ€¢ 5x faster speed\nâ€¢ Unlimited searches`;
    }

    return combinedResults;

  } catch (err) {
    console.error("Web search error:", err);
    return `ðŸŒ **Search for "${query}" unavailable**.\n\nðŸ”’ Browsers restrict public search.\nâœ… **Desktop app bypasses all limits!**`;
  }
}

// --- CHAT FUNCTION ---
function handleKeyPress(e) {
if(e.key === 'Enter' && !e.shiftKey) { 
e.preventDefault(); 
sendMessage(); 
}
}

async function sendMessage() {
const input = document.getElementById('user-input');
const text = input.value.trim();
const key = localStorage.getItem('groq_key');
const webSearchEnabled = document.getElementById('webSearchToggle').checked;

if (!text || isProcessing) return;

if (!key) {
checkKey();
return;
}

if (isRecording) stopRecording();

const chat = chats.find(c => c.id === activeId);
if (!chat) return;

// Handle editing (no longer needed due to truncation, but kept for safety)
if (editingMessageId !== null) {
chat.messages[editingMessageId].content = text;
saveChats();
selectChat(activeId);
editingMessageId = null;
input.value = '';
return;
}

// Process files
const fileContext = await processFiles();
const fullText = text + fileContext;

// Add user message
chat.messages.push({ role: "user", content: fullText });
saveChats();
appendUI(fullText, true);
input.value = '';
uploadedFiles = [];
updateFilePreview();
isProcessing = true;

// Add loading indicator
appendUI('', false, true);

try {
let systemContext = "";

if (webSearchEnabled) {
const searchResults = await performWebSearch(text);
systemContext = `[WEB SEARCH RESULTS]\n${searchResults}\n\n[USE THE ABOVE TO ANSWER. MENTION DESKTOP APP IF RESULTS LIMITED.]`;

const loadingBubble = document.getElementById('loading-bubble');
if (loadingBubble) {
loadingBubble.querySelector('.p-3\\.5').innerHTML =
'<div class="flex items-center gap-2 text-blue-400"><i class="fa-solid fa-globe animate-spin"></i><span class="text-sm">Searching the web...</span></div>';
}
}

if (document.getElementById('assistantToggle').checked) {
if (!systemContext) systemContext = '';
systemContext += "\n[ASSISTANT MODE ENABLED: Provide detailed, helpful responses with multiple suggestions when appropriate.]";
}

const messages = systemContext ? 
[{ role: "system", content: systemContext }, ...chat.messages.slice(-10)] : 
chat.messages.slice(-10);

const response = await fetch("https://api.groq.com/openai/v1/chat/completions  ", {
method: "POST",
headers: {
"Authorization": `Bearer ${key}`,
"Content-Type": "application/json"
},
body: JSON.stringify({
model: activeModel.full,
messages: messages,
temperature: 0.7,
max_tokens: 2048,
stream: false
})
});

const data = await response.json();

// Remove loading bubble
const loadingBubble = document.getElementById('loading-bubble');
if (loadingBubble) loadingBubble.remove();

if (data.error) throw new Error(data.error.message || 'API Error');

const aiMsg = data.choices[0].message.content;
chat.messages.push({ role: "assistant", content: aiMsg });
saveChats();
appendUI(aiMsg, false);

} catch (err) {
const loadingBubble = document.getElementById('loading-bubble');
if (loadingBubble) loadingBubble.remove();
appendUI(`Error: ${err.message}. Please check your API key or try again.`, false);
console.error('Chat error:', err);
} finally {
isProcessing = false;
}
}

// --- EVENT LISTENERS ---
document.getElementById('webSearchToggle').onchange = (e) => {
if (e.target.checked && !desktopPromptShown) {
setTimeout(() => showDesktopPrompt('web'), 1000);
}
};

document.getElementById('assistantToggle').onchange = (e) => {
if (e.target.checked) {
document.body.classList.add('assistant-mode');
if (!desktopPromptShown) {
setTimeout(() => showDesktopPrompt('assistant'), 1000);
}
} else {
document.body.classList.remove('assistant-mode');
}
renderHistory();
};

// Initialize
window.onload = () => {
checkKey();
selectModel(0);
renderHistory();
selectChat(activeId);
initVoiceRecognition();
};
</script>
</body>
</html>