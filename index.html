<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Chat Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Custom Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #1e1e1e; }
::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }

#sidebar { transition: transform 0.3s ease-in-out, margin-left 0.3s ease-in-out; z-index: 50; }
.sidebar-closed { margin-left: -18rem; }

@media (max-width: 768px) {
    #sidebar { position: fixed; height: 100%; margin-left: 0; transform: translateX(-100%); width: 280px; }
    #sidebar.mobile-open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
    .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 40; backdrop-filter: blur(2px); }
    .mobile-overlay.active { display: block; }
    #desktop-sidebar-toggle { display: none; }
}

.model-slider { position: relative; display: flex; background: #2f2f2f; padding: 4px; border-radius: 12px; }
.model-option { position: relative; padding: 6px 16px; cursor: pointer; font-size: 13px; z-index: 10; transition: color 0.3s; font-weight: 500; }
.slider-bg { position: absolute; height: calc(100% - 8px); background: #3b82f6; border-radius: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
.animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

.typing-dot { width: 4px; height: 4px; background: #9ca3af; border-radius: 50%; animation: typing 1.4s infinite; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

.message-actions { position: absolute; top: -10px; right: 10px; display: none; gap: 4px; background: #2d2d2d; padding: 4px; border-radius: 8px; border: 1px solid #4b5563; z-index: 10; }
.message-container:hover .message-actions { display: flex; }

.message-action-btn { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 6px; background: #374151; color: #9ca3af; cursor: pointer; transition: all 0.2s; font-size: 12px; }
.message-action-btn:hover { background: #4b5563; color: white; }
</style>
</head>
<body class="bg-[#1e1e1e] text-gray-200 flex h-screen overflow-hidden font-sans">

<div id="mobileOverlay" class="mobile-overlay" onclick="toggleSidebarMobile()"></div>

<div id="apiKeyModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center hidden backdrop-blur-md px-4">
    <div class="bg-[#2d2d2d] p-8 rounded-2xl border border-gray-700 w-full max-w-sm text-center">
        <h3 class="text-xl font-bold mb-2 text-white">Groq Activation</h3>
        <input type="password" id="apiKeyInput" class="w-full bg-[#1e1e1e] border border-gray-600 rounded-lg p-3 text-sm outline-none focus:border-blue-500 mb-4 text-white" placeholder="GROQ API KEY">
        <button onclick="saveApiKey()" class="w-full py-3 bg-blue-600 rounded-lg font-bold text-white hover:bg-blue-500 transition shadow-lg">Initialize AI</button>
    </div>
</div>

<div id="nameModal" class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center hidden backdrop-blur-sm px-4">
    <div class="bg-[#2d2d2d] p-6 rounded-xl border border-gray-700 w-full max-w-xs shadow-2xl">
        <h3 class="text-lg font-bold mb-4 text-white">New Conversation</h3>
        <input type="text" id="chatNameInput" class="w-full bg-[#1e1e1e] border border-gray-600 rounded-lg p-3 text-sm outline-none focus:border-blue-500 mb-4 text-white" placeholder="Topic...">
        <div class="flex justify-end gap-2">
            <button onclick="closeModal()" class="px-4 py-2 text-sm text-gray-400">Cancel</button>
            <button onclick="confirmNewChat()" class="px-4 py-2 text-sm bg-blue-600 rounded-lg font-semibold text-white">Create</button>
        </div>
    </div>
</div>

<aside id="sidebar" class="w-72 bg-[#171717] flex flex-col border-r border-gray-800 relative shrink-0">
    <button id="desktop-sidebar-toggle" onclick="toggleSidebarDesktop()" class="absolute -right-8 top-6 bg-[#171717] p-2 w-8 h-10 border-y border-r border-gray-800 rounded-r-lg text-gray-400">
        <i id="toggleIcon" class="fa-solid fa-chevron-left text-xs"></i>
    </button>
    
    <div class="p-4 flex flex-col h-full">
        <button onclick="openNameModal()" class="flex items-center gap-3 border border-gray-700 bg-[#1e1e1e] hover:bg-[#2a2a2a] rounded-xl p-3 mb-6 transition-all group">
            <div class="bg-blue-600/20 p-1.5 rounded-lg group-hover:bg-blue-600 transition">
                <i class="fa-solid fa-plus text-blue-400 text-xs group-hover:text-white"></i>
            </div>
            <span class="text-sm font-medium text-gray-300 group-hover:text-white">New Chat</span>
        </button>

        <div class="flex-1 overflow-y-auto pr-2 -mr-2">
            <div id="history-list" class="space-y-1"></div>
        </div>

        <div class="mt-auto pt-4 border-t border-gray-800">
            <button onclick="resetKey()" class="text-[10px] text-gray-600 hover:text-red-400 w-full text-center pb-2">Logout / Clear Data</button>
        </div>
    </div>
</aside>

<main class="flex-1 flex flex-col relative min-w-0 bg-[#1e1e1e]">
    <header class="h-16 border-b border-gray-800 flex items-center justify-between px-4 sticky top-0 bg-[#1e1e1e]/90 backdrop-blur z-40">
        <button onclick="toggleSidebarMobile()" class="md:hidden p-2 text-gray-400">
            <i class="fa-solid fa-bars text-xl"></i>
        </button>

        <div class="model-slider shadow-lg mx-auto">
            <div class="slider-bg" id="sliderBg"></div>
            <div class="model-option text-white" onclick="selectModel(0)">Llama</div>
            <div class="model-option text-gray-400" onclick="selectModel(1)">Qwen</div>
            <div class="model-option text-gray-400" onclick="selectModel(2)">GPT</div>
        </div>
        <div class="w-8 md:hidden"></div>
    </header>

    <div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6"></div>

    <div class="p-4">
        <div class="max-w-3xl mx-auto relative">
            <div class="bg-[#2f2f2f] rounded-2xl border border-gray-700 flex items-end p-2 shadow-2xl focus-within:border-gray-500 transition-all">
                <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-none outline-none text-gray-200 placeholder-gray-500 p-3 max-h-32 resize-none" placeholder="Message AI..." onkeydown="handleKeyPress(event)"></textarea>
                <button onclick="sendMessage()" class="p-3 bg-white text-black rounded-xl hover:bg-gray-200 transition ml-1">
                    <i class="fa-solid fa-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>
</main>

<script>
/** * EDIT THIS SYSTEM PROMPT 
 * This is sent to the AI in every conversation.
 */
const GLOBAL_SYSTEM_PROMPT = "You are a professional and concise AI assistant. Always provide accurate information. If you use search results, synthesize them into a clear answer. AND Always reply in less words like  try to answer in 1 sentence if possible";

const modelConfig = [
    { short: "Llama", full: "llama-3.3-70b-versatile" },
    { short: "Qwen", full: "qwen/qwen3-32b" },
    { short: "GPT", full: "openai/gpt-oss-120b" }
];

let activeModel = modelConfig[0];
let chats = JSON.parse(localStorage.getItem('chats')) || [{ id: Date.now(), title: "New Conversation", messages: [] }];
let activeId = chats[0].id;
let isProcessing = false;

// --- CORE FUNCTIONS ---
function saveApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (key) { 
        localStorage.setItem('groq_key', key); 
        document.getElementById('apiKeyModal').classList.add('hidden');
    }
}

function checkKey() { 
    if (!localStorage.getItem('groq_key')) document.getElementById('apiKeyModal').classList.remove('hidden');
}

function resetKey() { 
    if(confirm("Logout?")) { localStorage.clear(); location.reload(); }
}

function selectModel(index) {
    activeModel = modelConfig[index];
    const bg = document.getElementById('sliderBg');
    const options = document.querySelectorAll('.model-option');
    bg.style.width = options[index].offsetWidth + 'px';
    bg.style.left = options[index].offsetLeft + 'px';
    options.forEach((opt, i) => {
        opt.classList.toggle('text-white', i === index);
        opt.classList.toggle('text-gray-400', i !== index);
    });
}

function toggleSidebarDesktop() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('sidebar-closed');
    document.getElementById('toggleIcon').className = sidebar.classList.contains('sidebar-closed') ? 'fa-solid fa-chevron-right text-xs' : 'fa-solid fa-chevron-left text-xs';
}

function toggleSidebarMobile() {
    document.getElementById('sidebar').classList.toggle('mobile-open');
    document.getElementById('mobileOverlay').classList.toggle('active');
}

function openNameModal() { document.getElementById('nameModal').classList.remove('hidden'); }
function closeModal() { document.getElementById('nameModal').classList.add('hidden'); }

function confirmNewChat() {
    const name = document.getElementById('chatNameInput').value || "New Chat";
    const newId = Date.now();
    chats.unshift({ id: newId, title: name, messages: [] });
    localStorage.setItem('chats', JSON.stringify(chats));
    closeModal();
    selectChat(newId);
    if(document.getElementById('sidebar').classList.contains('mobile-open')) toggleSidebarMobile();
}

function renderHistory() {
    document.getElementById('history-list').innerHTML = chats.map(chat => `
        <div onclick="selectChat(${chat.id})" class="group flex items-center justify-between p-3 rounded-lg cursor-pointer text-sm transition ${chat.id === activeId ? 'bg-[#2f2f2f] text-white border-l-4 border-blue-500' : 'text-gray-400 hover:bg-[#252525]'}">
            <span class="truncate w-40">${chat.title}</span>
            <button onclick="event.stopPropagation(); deleteChat(${chat.id})" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-400">
                <i class="fa-solid fa-trash text-xs"></i>
            </button>
        </div>`).join('');
}

function deleteChat(id) {
    chats = chats.filter(c => c.id !== id);
    if (chats.length === 0) chats = [{ id: Date.now(), title: "New Chat", messages: [] }];
    activeId = chats[0].id;
    localStorage.setItem('chats', JSON.stringify(chats));
    selectChat(activeId);
}

function selectChat(id) {
    activeId = id;
    const chat = chats.find(c => c.id === id);
    document.getElementById('chat-window').innerHTML = '';
    chat.messages.forEach((m, idx) => appendUI(m.content, m.role === 'user', false, idx));
    renderHistory();
}

function appendUI(text, isUser, isLoading = false, index = null) {
    const window = document.getElementById('chat-window');
    const id = isLoading ? 'id="loading-bubble"' : '';
    const content = isLoading ? `<div class="flex gap-1 py-2"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>` : text.replace(/\n/g, '<br>');

    const html = `
    <div ${id} class="message-container flex ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in relative">
        ${isUser && index !== null ? `<div class="message-actions"><button onclick="deleteMsg(${index})" class="message-action-btn"><i class="fa-solid fa-trash"></i></button></div>` : ''}
        <div class="max-w-[85%] flex ${isUser ? 'flex-row-reverse' : 'flex-row'} gap-3">
            <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-[10px] font-bold ${isUser ? 'bg-gray-600' : 'bg-blue-600'} text-white">${isUser ? 'U' : 'AI'}</div>
            <div class="p-3 rounded-2xl text-[15px] ${isUser ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-[#2f2f2f] text-gray-200 rounded-tl-none'}">
                ${content}
            </div>
        </div>
    </div>`;
    window.insertAdjacentHTML('beforeend', html);
    window.scrollTo(0, window.scrollHeight);
}

function deleteMsg(idx) {
    const chat = chats.find(c => c.id === activeId);
    chat.messages = chat.messages.slice(0, idx);
    localStorage.setItem('chats', JSON.stringify(chats));
    selectChat(activeId);
}

// --- SEARCH LOGIC (BACKGROUND) ---
async function backgroundWebSearch(query) {
    let results = `Search query: ${query}\n`;
    try {
        const wiki = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
        if (wiki.ok) {
            const data = await wiki.json();
            results += `Wikipedia: ${data.extract}\n`;
        }
    } catch(e) {}
    return results;
}

// --- SEND LOGIC ---
function handleKeyPress(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }

async function sendMessage() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    const key = localStorage.getItem('groq_key');

    if (!text || isProcessing || !key) { if(!key) checkKey(); return; }

    const chat = chats.find(c => c.id === activeId);
    chat.messages.push({ role: "user", content: text });
    appendUI(text, true, false, chat.messages.length - 1);
    input.value = '';
    isProcessing = true;
    appendUI('', false, true);

    try {
        const searchData = await backgroundWebSearch(text);
        
        // COMBINING GLOBAL PROMPT + SEARCH + USER MESSAGES
        const finalSystemMessage = `${GLOBAL_SYSTEM_PROMPT}\n\nContext from Web Search:\n${searchData}`;
        
        const messages = [
            { role: "system", content: finalSystemMessage },
            ...chat.messages.slice(-10)
        ];

        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: activeModel.full,
                messages: messages,
                temperature: 0.7
            })
        });

        const data = await response.json();
        document.getElementById('loading-bubble').remove();
        
        if (data.choices) {
            const aiMsg = data.choices[0].message.content;
            chat.messages.push({ role: "assistant", content: aiMsg });
            localStorage.setItem('chats', JSON.stringify(chats));
            appendUI(aiMsg, false);
        }
    } catch (err) {
        if(document.getElementById('loading-bubble')) document.getElementById('loading-bubble').remove();
        appendUI("Error connecting to AI.", false);
    } finally {
        isProcessing = false;
    }
}

window.onload = () => {
    checkKey();
    selectModel(0);
    renderHistory();
    selectChat(activeId);
};
</script>
</body>
</html>
